# VerAgents RAG System (VRAG)

---

## ğŸ“– æ¦‚è¿° - Overview

**VerAgents RAG System (VRAG)** æ˜¯ VerAgents æ™ºèƒ½ä½“æ¡†æ¶ä¸­çš„æ ¸å¿ƒå·¥å…·å‹å­ç³»ç»Ÿã€‚ä¸é€šç”¨çš„è®°å¿†ç³»ç»Ÿï¼ˆMemory Systemï¼‰ä¸åŒï¼ŒVRAG ä¸“ä¸ºå¤„ç†å¤§è§„æ¨¡éç»“æ„åŒ–æ–‡æ¡£ã€çŸ¥è¯†åº“é—®ç­”ï¼ˆKBQAï¼‰å’Œå¢å¼ºæ£€ç´¢ç”Ÿæˆï¼ˆRetrieval-Augmented Generationï¼‰ä»»åŠ¡è€Œè®¾è®¡ã€‚

å®ƒé‡‡ç”¨äº†**â€œäº”å±‚ä¸ƒæ­¥â€**çš„å…ˆè¿›æ¶æ„è®¾è®¡ï¼Œæ—¨åœ¨æä¾›**æ¨¡å—åŒ–ã€å¯æ‰©å±•ã€é«˜æ€§èƒ½**çš„ RAG è§£å†³æ–¹æ¡ˆã€‚

*   **äº”å±‚**ï¼šç”¨æˆ·å±‚ã€åº”ç”¨å±‚ã€å¤„ç†å±‚ã€å­˜å‚¨å±‚ã€åŸºç¡€å±‚ã€‚
*   **ä¸ƒæ­¥**ï¼šç”¨æˆ·è¯·æ±‚ -> æ¥å£è·¯ç”± -> åº”ç”¨é€»è¾‘ -> æ–‡æ¡£è§£æ -> æ™ºèƒ½åˆ†å— -> å‘é‡åŒ– -> å­˜å‚¨/æ£€ç´¢ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„ - Architecture

### 1. äº”å±‚æ¶æ„è®¾è®¡

è¿™ç§åˆ†å±‚è®¾è®¡çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äº**æ¯ä¸€å±‚éƒ½å¯ä»¥ç‹¬ç«‹ä¼˜åŒ–å’Œæ›¿æ¢**ï¼Œç¡®ä¿ç³»ç»Ÿçš„çµæ´»æ€§ä¸ç¨³å®šæ€§ã€‚

| å±‚çº§ | èŒè´£æè¿° | å…³é”®ç»„ä»¶/æŠ€æœ¯ |
| :--- | :--- | :--- |
| **ç”¨æˆ·å±‚ (User Layer)** | ç»Ÿä¸€äº¤äº’æ¥å£ï¼Œå±è”½åº•å±‚å¤æ‚æ€§ã€‚ | **`RAGTool`** (æ ‡å‡† Agent å·¥å…·æ¥å£), CLI |
| **åº”ç”¨å±‚ (App Layer)** | å…·ä½“ä¸šåŠ¡é€»è¾‘å®ç°ã€‚ | æ™ºèƒ½é—®ç­” (QA), è¯­ä¹‰æœç´¢, çŸ¥è¯†åº“ç®¡ç† |
| **å¤„ç†å±‚ (Process Layer)** | æ–‡æ¡£åˆ°æ•°æ®çš„æ ¸å¿ƒè½¬æ¢æµç¨‹ã€‚ | **`MarkItDown`** (å…¨æ ¼å¼è§£æ), **Markdown æ™ºèƒ½åˆ†å—**, Token è®¡ç®— |
| **å­˜å‚¨å±‚ (Storage Layer)** | æŒä¹…åŒ–ä¸ç´¢å¼•ã€‚ | **`Qdrant`** (å‘é‡æ•°æ®åº“), **`SQLite`** (æ–‡æ¡£æ­£æ–‡/å…ƒæ•°æ®) |
| **åŸºç¡€å±‚ (Infra Layer)** | åº•å±‚æ¨¡å‹ä¸è®¡ç®—èµ„æºã€‚ | Embedding Models (OpenAI/Ollama/HuggingFace), LLM, Neo4j (å¯é€‰å›¾è°±) |

### 2. æ ¸å¿ƒå¤„ç†æµç¨‹ (The Pipeline)

æ•´ä¸ªæµç¨‹éµå¾ªæ ‡å‡†åŒ–çš„æ•°æ®æµå‘ï¼š

1.  **Ingest (æ‘„å…¥)**ï¼šæ¥æ”¶ä»»æ„æ ¼å¼æ–‡æ¡£ã€‚
2.  **Convert (è½¬æ¢)**ï¼šé€šè¿‡ `MarkItDown` ç»Ÿä¸€è½¬æ¢ä¸º **Markdown** æ ¼å¼ã€‚
3.  **Chunk (åˆ†å—)**ï¼šåŸºäº Markdown ç»“æ„çš„æ™ºèƒ½åˆ†å—ç­–ç•¥ã€‚
4.  **Embed (å‘é‡åŒ–)**ï¼šæ‰¹é‡ç”Ÿæˆ Embedding å‘é‡ã€‚
5.  **Index (ç´¢å¼•)**ï¼šå­˜å…¥ Qdrant å¹¶æ„å»º Payload ç´¢å¼•ã€‚
6.  **Retrieve (æ£€ç´¢)**ï¼šå¤šç­–ç•¥æ··åˆæ£€ç´¢ (MQE + HyDE)ã€‚
7.  **Generate (ç”Ÿæˆ)**ï¼šLLM åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆæœ€ç»ˆå›ç­”ã€‚

```mermaid
graph LR
    Doc[ä»»æ„æ–‡æ¡£] --> MarkItDown[MarkItDownè½¬æ¢]
    MarkItDown --> Markdown[Markdownæ–‡æœ¬]
    Markdown --> SmartChunk[æ™ºèƒ½åˆ†å—]
    SmartChunk --> Vectors[å‘é‡åŒ–]
    Vectors --> Qdrant[(Qdrantå­˜å‚¨)]
    Query[ç”¨æˆ·æŸ¥è¯¢] --> Retrieval[å¤šç­–ç•¥æ£€ç´¢]
    Retrieval --> LLM[LLMç”Ÿæˆ]
```

---

## ğŸš€ å…³é”®ç‰¹æ€§ - Key Features

### 1. å…¨æ ¼å¼æ–‡æ¡£å¤„ç† (powered by MarkItDown)

VRAG é›†æˆäº†å¾®è½¯å¼€æºçš„ `MarkItDown` å·¥å…·ï¼Œèƒ½å¤Ÿå°†å‡ ä¹æ‰€æœ‰å¸¸è§æ–‡æ¡£æ ¼å¼ç»Ÿä¸€è½¬æ¢ä¸ºé«˜è´¨é‡çš„ Markdown æ–‡æœ¬ã€‚è¿™æ„å‘³ç€åç»­çš„å¤„ç†æµç¨‹ï¼ˆåˆ†å—ã€å‘é‡åŒ–ï¼‰åªéœ€é’ˆå¯¹ Markdown è¿™ä¸€ç§æ ¼å¼è¿›è¡Œä¼˜åŒ–ã€‚

*   **æ”¯æŒæ ¼å¼**ï¼šPDF, Word (.docx), Excel (.xlsx), PowerPoint (.pptx), Images (OCR), Audio (Transcription), HTML, JSON, XML, Code, etc.
*   **ä¼˜åŠ¿**ï¼šä¿ç•™æ–‡æ¡£çš„ç»“æ„ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€åˆ—è¡¨ã€è¡¨æ ¼ï¼‰ï¼Œä¸ºåç»­çš„æ™ºèƒ½åˆ†å—æä¾›è¯­ä¹‰åŸºç¡€ã€‚

### 2. Markdown æ„ŸçŸ¥æ™ºèƒ½åˆ†å— (Structure-Aware Chunking)

ä¼ ç»Ÿçš„æŒ‰å­—ç¬¦æ•°åˆ†å—ï¼ˆFixed-size Chunkingï¼‰å¾€å¾€ä¼šç ´åè¯­ä¹‰å®Œæ•´æ€§ã€‚VRAG å®ç°äº†**åŸºäº Markdown ç»“æ„çš„æ™ºèƒ½åˆ†å—ç®—æ³•**ï¼š

*   **æ ‡é¢˜å±‚çº§è§£æ**ï¼šè‡ªåŠ¨è¯†åˆ« `#`, `##` ç­‰æ ‡é¢˜ï¼Œå°†æ–‡æ¡£åˆ†å‰²ä¸ºå…·æœ‰è¯­ä¹‰å±‚çº§çš„æ®µè½ã€‚
*   **è¯­ä¹‰è¾¹ç•Œä¿æŒ**ï¼šç¡®ä¿åŒä¸€æ®µè½å†…å®¹å°½é‡ä¸è¢«åˆ‡æ–­ã€‚
*   **Token çº§æ§åˆ¶**ï¼šç»“åˆè¿‘ä¼¼ Token è®¡æ•°ï¼ˆæ”¯æŒä¸­è‹±æ–‡æ··åˆï¼‰ï¼Œç²¾ç¡®æ§åˆ¶åˆ†å—å¤§å°ï¼ˆå¦‚ 512 tokensï¼‰ã€‚
*   **é‡å ä¼˜åŒ–**ï¼šåœ¨åˆ†å—è¾¹ç•Œæ·»åŠ é‡å å†…å®¹ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯ã€‚
*   **å…ƒæ•°æ®å¢å¼º**ï¼šæ¯ä¸ªåˆ†å—è‡ªåŠ¨æºå¸¦å…¶æ‰€å±çš„ `heading_path`ï¼ˆå¦‚ "æ·±åº¦å­¦ä¹  > CNN > å·ç§¯å±‚"ï¼‰ï¼Œæå¤§æå‡äº†æ£€ç´¢ç»“æœçš„å¯è§£é‡Šæ€§ã€‚

### 3. å¤šç­–ç•¥é«˜çº§æ£€ç´¢ (Advanced Retrieval)

VRAG ä¸ä»…ä»…æ˜¯ç®€å•çš„å‘é‡ç›¸ä¼¼åº¦åŒ¹é…ï¼Œè¿˜å†…ç½®äº†ä¸¤ç§é«˜çº§æ£€ç´¢ç­–ç•¥ï¼Œæ˜¾è‘—æå‡å¤æ‚æŸ¥è¯¢çš„å¬å›ç‡å’Œå‡†ç¡®ç‡ï¼š

*   **MQE (Multi-Query Expansion, å¤šæŸ¥è¯¢æ‰©å±•)**ï¼š
    *   **åŸç†**ï¼šåˆ©ç”¨ LLM å°†ç”¨æˆ·çš„ä¸€ä¸ªé—®é¢˜æ”¹å†™ä¸ºå¤šä¸ªè¯­ä¹‰ç­‰ä»·çš„æŸ¥è¯¢ï¼ˆå¦‚ "å¦‚ä½•å­¦Python" -> "Pythonå…¥é—¨æ•™ç¨‹", "Pythonå­¦ä¹ è·¯å¾„"ï¼‰ã€‚
    *   **ä¼˜åŠ¿**ï¼šè¦†ç›–æ›´å¤šæ½œåœ¨çš„æ–‡æ¡£å…³é”®è¯ï¼Œç‰¹åˆ«æ˜¯è§£å†³ç”¨æˆ·æé—®è¡¨è¿°ä¸å‡†ç¡®çš„é—®é¢˜ã€‚
    *   **å®ç°**ï¼šå¹¶è¡Œæ£€ç´¢æ‰©å±•åçš„æ‰€æœ‰æŸ¥è¯¢ï¼Œé€šè¿‡å»é‡ä¸é‡æ’åºï¼ˆRerankï¼‰åˆå¹¶ç»“æœã€‚

*   **HyDE (Hypothetical Document Embeddings, å‡è®¾æ–‡æ¡£åµŒå…¥)**ï¼š
    *   **åŸç†**ï¼šåˆ©ç”¨ LLM é’ˆå¯¹ç”¨æˆ·é—®é¢˜ç”Ÿæˆä¸€ä¸ªâ€œå‡è®¾æ€§ç­”æ¡ˆâ€ï¼ˆHypothetical Answerï¼‰ï¼Œç„¶åç”¨è¿™ä¸ªå‡è®¾ç­”æ¡ˆå»æ£€ç´¢çœŸå®æ–‡æ¡£ã€‚
    *   **ä¼˜åŠ¿**ï¼šå°†â€œé—®é¢˜-æ–‡æ¡£â€åŒ¹é…è½¬åŒ–ä¸ºâ€œç­”æ¡ˆ-æ–‡æ¡£â€åŒ¹é…ï¼Œæ˜¾è‘—æå‡è¯­ä¹‰ç›¸ä¼¼åº¦ï¼Œç‰¹åˆ«é€‚åˆäº‹å®ç±»é—®ç­”ã€‚

### 4. ç»Ÿä¸€æ¥å£ (Standardized Tool Interface)

VRAG éµå¾ª VerAgents çš„å·¥å…·æ ‡å‡†ï¼Œä»¥ `rag_tool` çš„å½¢å¼æä¾›æœåŠ¡ï¼Œè¿™ä½¿å¾— Agent å¯ä»¥ç›´æ¥è°ƒç”¨ RAG èƒ½åŠ›ï¼Œæ— éœ€å…³å¿ƒåº•å±‚å®ç°ã€‚

*   `rag_ingest_file(path)`: æ™ºèƒ½è½½å…¥æ–‡ä»¶ã€‚
*   `rag_query(question)`: ç«¯åˆ°ç«¯é—®ç­”ã€‚
*   `rag_search(query)`: çº¯æ£€ç´¢ï¼Œè¿”å›ç›¸å…³ç‰‡æ®µã€‚

---

## ğŸ› ï¸ é…ç½®è¯´æ˜ - Configuration

VRAG ä¾èµ–ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ï¼Œä¸ Memory System å…±äº«éƒ¨åˆ†åŸºç¡€è®¾ç½®ã€‚

```env
# RAG ä¸“ç”¨å‘é‡å­˜å‚¨é…ç½®
QDRANT_URL=https://your-cluster.qdrant.io
QDRANT_API_KEY=your_key
QDRANT_COLLECTION=rag_knowledge_base  # RAG ä¸“ç”¨é›†åˆ

# LLM ä¸ Embedding (ç”¨äºåˆ†å—ã€æ‰©å±•æŸ¥è¯¢ã€ç”Ÿæˆå›ç­”)
PROVIDER=openai  # æˆ– zhipu, intern, aiping ç­‰
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_API_KEY=sk-...
EMBED_MODEL_NAME=text-embedding-3-small
```

---

## ğŸ’» ä½¿ç”¨ç¤ºä¾‹ - Usage

### Python API

```python
from veragents.memory.rag import create_rag_pipeline

# 1. åˆå§‹åŒ–
pipeline = create_rag_pipeline(
    knowledge_base_path="./my_kb",
    collection_name="my_rag_collection"
)

# 2. è½½å…¥æ–‡æ¡£ (æ”¯æŒä»»æ„æ ¼å¼)
pipeline.ingest_file("data/manual.pdf")
pipeline.ingest_file("data/report.docx")

# 3. ç®€å•æ£€ç´¢
results = pipeline.search("æ ¸å¿ƒæ¶æ„æ˜¯ä»€ä¹ˆï¼Ÿ", top_k=3)

# 4. é«˜çº§é—®ç­” (å¯ç”¨ MQE å’Œ HyDE)
answer = pipeline.query(
    "æ€»ç»“ä¸€ä¸‹äº”å±‚æ¶æ„çš„ä¼˜åŠ¿",
    enable_mqe=True,
    enable_hyde=True
)
print(answer['answer'])
```

### Agent Tool è°ƒç”¨

ä½œä¸º Agentï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æ³¨å†Œçš„å·¥å…·ï¼š

```python
# å‡è®¾ tool_manager å·²åŠ è½½ rag_tool
result = tool_manager.call(
    "rag_query", 
    question="é¡¹ç›®çš„æ—¶é—´çº¿æ˜¯æ€æ ·çš„ï¼Ÿ",
    enable_mqe=True
)
```

è¯¦ç»†ä»£ç æ¼”ç¤ºè¯·å‚è€ƒ `examples/memory/rag_demo.py`ã€‚
